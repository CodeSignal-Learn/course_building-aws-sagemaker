name: Generate and Release Data

on:
  push:
    branches: [ main ]
    paths: 
      - 'utils/download_and_preprocess_datasets.py'
      - '.github/workflows/release-and-deploy.yml'
      - '*.py'
      - 'template_requirements.txt'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for creating releases
  pages: write     # Required for GitHub Pages
  id-token: write  # Required for GitHub Pages

jobs:
  generate-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas==2.2.3 scikit-learn==1.6.1
        
    - name: Generate data files
      run: |
        python utils/download_and_preprocess_datasets.py
        
    - name: Create data archive
      run: |
        tar -czf california-housing-data.tar.gz data/
        ls -lh california-housing-data.tar.gz
        
    - name: Create source code archive
      run: |
        # Create a clean source archive with only the source files we want
        tar -czf aws-sagemaker-course-source.tar.gz \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            *.py \
            models/ \
            template_requirements.txt \
            README.md
        ls -lh aws-sagemaker-course-source.tar.gz
        
    - name: Create Release with Data and Source Code
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: AWS SageMaker Course Release v${{ github.run_number }}
        body: |
          ## üè† AWS SageMaker Course Materials
          
          This release includes both **data files** and **source code** for the AWS SageMaker course.
          
          ### üìä **Data Files** (california-housing-data.tar.gz)
          - `california_housing.csv` - Original dataset (**20,640 rows**)
          - `california_housing_train.csv` - Training set (**16,512 rows**) 
          - `california_housing_test.csv` - Test set (**4,128 rows**)
          
          ### ü§ñ **Pre-trained Model**
          - `trained_model.joblib` - Ready-to-use LinearRegression model (**Simple scikit-learn model**)
          
          ### üêç **Source Code** (aws-sagemaker-course-source.tar.gz)
          - `train.py` - SageMaker training script for California Housing dataset
          - `entry_point.py` - SageMaker model inference entry point
          - `common.py` - Shared functions and utilities used by all templates
          - `sagemakerTraining.py` - Creates SageMaker training jobs (Estimator + ModelTrainer)
          - `sagemakerDeployServerless.py` - Model deployment examples (3 serverless endpoints)
          - `sagemakerDeployRealTime.py` - Model deployment examples (3 serverless endpoints + 1 real-time endpoint)
          - `template_requirements.txt` - Python package dependencies to run templates
          
          ### üöÄ **Quick Start**
          ```bash
          # Download everything
          wget https://github.com/${{ github.repository }}/releases/download/v${{ github.run_number }}/california-housing-data.tar.gz
          wget https://github.com/${{ github.repository }}/releases/download/v${{ github.run_number }}/aws-sagemaker-course-source.tar.gz
          wget https://github.com/${{ github.repository }}/releases/download/v${{ github.run_number }}/trained_model.joblib
          
          # Extract files
          tar -xzf california-housing-data.tar.gz
          tar -xzf aws-sagemaker-course-source.tar.gz
          
          # Install dependencies and run
          pip install -r template_requirements.txt
          python sagemakerTraining.py          # Training jobs
          python sagemakerDeployServerless.py  # Models deployment
          python sagemakerDeployRealTime.py    # Models deployment
          ```
          
          ### üìà **Dataset Features**
          - **Original**: MedInc, HouseAge, AveRooms, AveBedrms, Population, AveOccup, Latitude, Longitude, MedHouseVal
          - **Train/Test**: Additional `RoomsPerHousehold` feature + capped values at 95th percentile
          - **Split**: 80% train / 20% test (random_state=42)

          ---
          *Generated automatically from commit `${{ github.sha }}`*
        files: |
          california-housing-data.tar.gz
          aws-sagemaker-course-source.tar.gz
          data/california_housing.csv
          data/california_housing_train.csv
          data/california_housing_test.csv
          models/trained_model.joblib
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create index page for GitHub Pages
      run: |
        cat > data/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>California Housing Dataset</title>
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; line-height: 1.6; }
                .download-section { background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin: 1rem 0; }
                .file-list { list-style: none; padding: 0; }
                .file-list li { margin: 0.5rem 0; }
                .file-list a { text-decoration: none; color: #0366d6; font-weight: 500; }
                .file-list a:hover { text-decoration: underline; }
                .size { color: #586069; font-size: 0.9em; }
                .release-link { background: #28a745; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 6px; display: inline-block; margin: 0.5rem 0; }
                .release-link:hover { background: #218838; color: white; }
                pre { background: #f6f8fa; padding: 1rem; border-radius: 6px; overflow-x: auto; }
                code { background: #f6f8fa; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.9em; }
            </style>
        </head>
        <body>
            <h1>üè† California Housing Dataset</h1>
            <p>Generated California Housing dataset files for machine learning projects.</p>
            
            <div class="download-section">
                <h2>üì• Download Individual Files</h2>
                <ul class="file-list">
                    <li><a href="california_housing.csv">california_housing.csv</a> <span class="size">(~1.8MB, 20,640 rows)</span></li>
                    <li><a href="california_housing_train.csv">california_housing_train.csv</a> <span class="size">(~1.8MB, 16,512 rows)</span></li>
                    <li><a href="california_housing_test.csv">california_housing_test.csv</a> <span class="size">(~449KB, 4,128 rows)</span></li>
                </ul>
                
                <h3>ü§ñ Pre-trained Model</h3>
                <ul class="file-list">
                    <li><a href="https://github.com/CodeSignal-Learn/course_building-aws-sagemaker/releases/latest/download/trained_model.joblib">trained_model.joblib</a> <span class="size">(LinearRegression Model)</span></li>
                </ul>
            </div>
            
            <div class="download-section">
                <h2>üì¶ Complete Package (Data + Source Code)</h2>
                <p>For the complete course materials including Python source code:</p>
                <a href="https://github.com/CodeSignal-Learn/course_building-aws-sagemaker/releases/latest" class="release-link">üöÄ Download Latest Release</a>
                <p><small>Includes data files, training scripts, and dependencies</small></p>
            </div>
            
            <h2>üîó Quick Access URLs</h2>
            <pre><code># Data files
        wget https://codesignal-learn.github.io/course_building-aws-sagemaker/california_housing_train.csv
        wget https://codesignal-learn.github.io/course_building-aws-sagemaker/california_housing_test.csv
        
        # Pre-trained model
        wget https://github.com/CodeSignal-Learn/course_building-aws-sagemaker/releases/latest/download/trained_model.joblib</code></pre>
            
            <h2>üìä Dataset Information</h2>
            <p><strong>Source:</strong> Scikit-learn California Housing Dataset</p>
            <p><strong>Target:</strong> Median house value prediction</p>
            <p><strong>Split:</strong> 80% train / 20% test (random_state=42)</p>
            
            <h3>Features</h3>
            <ul>
                <li><strong>Original (9 features):</strong> MedInc, HouseAge, AveRooms, AveBedrms, Population, AveOccup, Latitude, Longitude, MedHouseVal</li>
                <li><strong>Train/Test (10 features):</strong> Original features + RoomsPerHousehold (engineered feature)</li>
                <li><strong>Preprocessing:</strong> Values capped at 95th percentile (excluding coordinates)</li>
            </ul>
            
            <footer style="margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #e1e4e8; color: #586069; font-size: 0.9em;">
                <p>Generated automatically via GitHub Actions</p>
            </footer>
        </body>
        </html>
        EOF
        
    - name: Setup Pages
      uses: actions/configure-pages@v5
      with:
        enablement: true
      
    - name: Upload artifact for GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: './data'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4 